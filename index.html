<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Scoreboard System (Townhall 2026)</title>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB2ls46sUauR-lPttvahhww3BiHIBr5Gek",
            authDomain: "townhall-37c18.firebaseapp.com",
            databaseURL: "https://townhall-37c18-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "townhall-37c18",
            storageBucket: "townhall-37c18.firebasestorage.app",
            messagingSenderId: "728485322328",
            appId: "1:728485322328:web:783c2aeb40cefee23f342d"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        window.firebaseDB = db;
        window.firebaseRef = ref;
        window.firebaseOnValue = onValue;
        window.firebaseSet = set;
    </script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Prompt', 'sans-serif'] },
                    colors: { slate: { 50: '#f8fafc', 100: '#f1f5f9', 200: '#e2e8f0', 800: '#1e293b', 900: '#0f172a' } }
                }
            }
        }
    </script>
    <style>
        /* Responsive Base Settings */
        :root {
            --card-padding: 0.6rem;
            --font-base: 14px;
        }

        body { font-size: var(--font-base); }
        .responsive-container { width: 100%; padding: 0.5rem; }

        @media screen and (min-width: 768px) {
            :root { --card-padding: 1rem; --font-base: 15px; }
            .responsive-container { width: 96%; margin: 0 auto; }
        }

        @media screen and (min-width: 1024px) {
            :root { --card-padding: 1.2rem; --font-base: 16px; }
            .responsive-container { width: 98%; max-width: 1400px; margin: 0 auto; }
        }

        @media screen and (min-width: 1440px) {
             :root { --card-padding: 1.5rem; --font-base: 18px; }
        }

        /* BACKGROUND FIX */
        body { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #1e293b; 
            min-height: 100vh;
            background-attachment: fixed;
        }

        /* Mode Styles */
        body.mode-display { overflow: hidden; height: 100vh; width: 100vw; position: fixed; top: 0; left: 0; }
        body.mode-admin { overflow-y: auto; height: auto; position: relative; }
        body.mode-sound { overflow-y: auto; height: auto; position: relative; }
        
        /* Decorations */
        .bg-decoration { position: absolute; border-radius: 50%; filter: blur(100px); opacity: 0.3; pointer-events: none; z-index: 0; }
        .star { position: absolute; background: white; clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%); animation: twinkle 3s infinite; }
        @keyframes twinkle { 0%, 100% { opacity: 0.3; transform: scale(1); } 50% { opacity: 1; transform: scale(1.2); } }
        .firework-particle { position: absolute; width: 6px; height: 6px; border-radius: 50%; pointer-events: none; }

        .score-anim { transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .score-anim.pop { transform: scale(1.3); }
        @keyframes medalFloat { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        .medal-icon { animation: medalFloat 3s ease-in-out infinite; display: inline-block; }
        @keyframes floatUpFade { 0% { opacity: 1; transform: translateY(0) scale(1); } 100% { opacity: 0; transform: translateY(-60px) scale(1.2); } }
        .floating-score { position: absolute; font-size: 3rem; font-weight: 900; animation: floatUpFade 1.5s ease-out forwards; pointer-events: none; z-index: 60; text-shadow: 0 4px 10px rgba(255,255,255,0.9); -webkit-text-stroke: 2px white; right: 40px; top: 20%; }

        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(0,0,0,0.05); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.3); border-radius: 10px; }

        .progress-container-custom {
            position: relative; width: 100%; height: 2.8rem; 
            background-color: #f1f5f9; border-radius: 999px; box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
            margin-top: 0.25rem; overflow: visible;
        }
        @media (min-width: 768px) { .progress-container-custom { height: 4rem; } }

        .progress-fill-custom { height: 100%; border-radius: 999px; transition: width 1s cubic-bezier(0.4, 0, 0.2, 1); position: relative; z-index: 10; }
        .progress-fill-custom::after { content: ''; position: absolute; top: 0; left: 0; bottom: 0; right: 0; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent); transform: translateX(-100%); animation: shimmer 3s infinite; border-radius: 999px; }
        @keyframes shimmer { 100% { transform: translateX(100%); } }

        .finish-tape-in-bar { position: absolute; right: 10px; top: 0; bottom: 0; width: 24px; z-index: 20; background-image: linear-gradient(45deg, #334155 25%, transparent 25%), linear-gradient(-45deg, #334155 25%, transparent 25%), linear-gradient(45deg, transparent 75%, #334155 75%), linear-gradient(-45deg, transparent 75%, #334155 75%); background-size: 12px 12px; background-position: 0 0, 0 6px, 6px -6px, -6px 0px; opacity: 0.8; border-left: 1px dashed rgba(255,255,255,0.5); border-right: 1px dashed rgba(255,255,255,0.5); }
        
        /* Mascot on Bar */
        .mascot-on-bar { position: absolute; bottom: -8px; transition: left 1s cubic-bezier(0.4, 0, 0.2, 1); z-index: 30; transform: scaleX(-1); pointer-events: none; }
        .mascot-on-bar img { width: 80px; height: 80px; object-fit: contain; filter: drop-shadow(2px 4px 6px rgba(0,0,0,0.3)); }
        @media (min-width: 768px) { .mascot-on-bar img { width: 150px; height: 150px; bottom: -20px; } }

        .confetti-finish { position: absolute; width: 8px; height: 8px; z-index: 50; border-radius: 50%; animation: finishExplosion 1.5s ease-out forwards; pointer-events: none; }
        @keyframes finishExplosion { 0% { transform: translate(0, 0) scale(1); opacity: 1; } 80% { opacity: 1; } 100% { transform: translate(var(--tx), var(--ty)) scale(0.5); opacity: 0; } }
        
        .winner-badge-mini { position: absolute; top: -25px; left: 50%; transform: translateX(-50%) scaleX(-1); display: flex; flex-direction: column; align-items: center; white-space: nowrap; }
        .winner-crown-mini { font-size: 1.5rem; animation: medalFloat 2s infinite; }

        .character-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(60px, 1fr)); gap: 8px; margin-top: 12px; }
        .character-option { cursor: pointer; border: 3px solid transparent; border-radius: 12px; padding: 4px; transition: all 0.3s; background: #f8fafc; }
        .character-option:hover { border-color: #3b82f6; transform: scale(1.05); box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3); }
        .character-option img { width: 100%; height: 50px; object-fit: contain; border-radius: 8px; }
        .character-option.selected { border-color: #22c55e; background: #dcfce7; }

        /* Dynamic Text Sizes */
        .text-responsive-title { font-size: clamp(1.8rem, 4vw, 4.5rem); }
        .text-responsive-target { font-size: clamp(0.9rem, 2vw, 1.8rem); }
        .text-responsive-rank { font-size: clamp(2rem, 5vw, 4.5rem); }
        .text-responsive-name { font-size: clamp(1.2rem, 2.5vw, 2.8rem); }
        .text-responsive-score { font-size: clamp(2rem, 5vw, 4.5rem); }

        .ranking-card { padding: var(--card-padding); }

        /* --- ULTIMATE EFFECT STYLES --- */
        #ultimate-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 9999;
            display: flex; justify-content: center; align-items: center;
            opacity: 0; transition: opacity 0.1s;
        }
        
        /* Flash Background */
        .flash-bg {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-color: white;
            animation: flashAnim 0.8s ease-out forwards;
        }

        /* Lightning */
        .lightning-effect {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: 
                linear-gradient(45deg, transparent 40%, rgba(255,255,255,0.8) 45%, transparent 50%),
                linear-gradient(-45deg, transparent 40%, rgba(255,255,255,0.8) 45%, transparent 50%);
            background-size: 200% 200%;
            mix-blend-mode: overlay;
            opacity: 0;
            animation: lightningAnim 0.5s ease-out infinite;
        }

        /* Character Cut-in */
        .cut-in-character {
            position: relative; z-index: 10;
            transform: scale(0.5) translateX(-100%);
            opacity: 0;
            animation: cutInAnim 1.2s cubic-bezier(0.17, 0.67, 0.83, 0.67) forwards;
            filter: drop-shadow(0 0 50px rgba(255,255,255,0.8));
        }
        .cut-in-character img {
            max-height: 80vh; max-width: 90vw;
            object-fit: contain;
        }

        @keyframes flashAnim {
            0% { opacity: 0.8; background-color: white; }
            10% { opacity: 0; }
            20% { opacity: 0.5; background-color: #fbbf24; }
            30% { opacity: 0; }
            40% { opacity: 0.3; background-color: white; }
            100% { opacity: 0; }
        }

        @keyframes lightningAnim {
            0% { background-position: 0% 0%; opacity: 0; }
            20% { background-position: 100% 100%; opacity: 1; }
            21% { opacity: 0; }
            40% { background-position: 0% 100%; opacity: 0.5; }
            100% { opacity: 0; }
        }

        @keyframes cutInAnim {
            0% { transform: scale(1.5) translateX(-50%); opacity: 0; }
            10% { transform: scale(1) translateX(0); opacity: 1; filter: brightness(2); }
            15% { filter: brightness(1); }
            80% { transform: scale(1.1) translateX(20px); opacity: 1; }
            100% { transform: scale(1.5) translateX(100%); opacity: 0; }
        }

        /* Sound Button Styles */
        .sound-button {
            position: relative;
            overflow: hidden;
            transition: all 0.3s;
        }
        .sound-button:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 24px rgba(0,0,0,0.2);
        }
        .sound-button.playing {
            animation: pulse 1s infinite;
            box-shadow: 0 0 30px currentColor;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        .sound-button::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255,255,255,0.5);
            transform: translate(-50%, -50%);
            transition: width 0.3s, height 0.3s;
        }
        .sound-button.playing::before {
            width: 300%;
            height: 300%;
        }
    </style>
</head>
<body class="flex flex-col">

    <audio id="sfx-score" src="https://raw.githubusercontent.com/noppadonpa-collab/townhall-2026/main/ORA%20ORA%20ORA%20-%20Sound%20effect.mp3"></audio>
    <audio id="sfx-display-hit" src="https://raw.githubusercontent.com/noppadonpa-collab/townhall-2026/main/ORA%20ORA%20ORA%20-%20Sound%20effect.mp3"></audio>
    <audio id="sfx-win" src="https://codeskulptor-demos.commondatastorage.googleapis.com/GalaxyInvaders/bonus.wav"></audio>
    <audio id="sfx-click" src="https://codeskulptor-demos.commondatastorage.googleapis.com/GalaxyInvaders/pause.wav"></audio>
    <audio id="sfx-thunder" src="https://codeskulptor-demos.commondatastorage.googleapis.com/GalaxyInvaders/explosion.wav"></audio>
    
    <!-- Event Sound Effects -->
    <audio id="sfx-champ1" src="champ1.mp3"></audio>
    <audio id="sfx-champ2" src="champ2.mp3"></audio>
    <audio id="sfx-open1" src="open1.mp3"></audio>
    <audio id="sfx-open2" src="open2.mp3"></audio>
    
    <audio id="bgm-normal" loop></audio>
    <audio id="bgm-excited" loop></audio>

    <div id="bg-decorations"></div>

    <div id="ultimate-overlay" class="hidden">
        <div id="effect-flash" class="flash-bg"></div>
        <div id="effect-lightning" class="lightning-effect"></div>
        <div id="effect-char" class="cut-in-character">
            <img id="ultimate-img" src="" alt="Ultimate">
        </div>
    </div>

    <div id="mode-selector" class="fixed inset-0 z-50 bg-gradient-to-br from-purple-600 to-blue-600 flex flex-col items-center justify-center space-y-8 p-4">
        <div class="text-center space-y-2">
            <h1 class="text-4xl md:text-6xl font-bold text-white drop-shadow-lg">üèÜ ‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏±‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô Townhall 2026</h1>
            <p class="text-white/80 text-lg">*‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á</p>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 w-full max-w-4xl">
            <button onclick="enterMode('display')" class="group px-6 py-6 bg-white rounded-3xl border-2 border-blue-100 hover:border-blue-500 shadow-xl hover:shadow-2xl hover:-translate-y-1 transition-all duration-300 flex flex-col items-center">
                <div class="text-5xl mb-4 group-hover:scale-110 transition-transform">üì∫</div>
                <div class="text-xl font-bold text-slate-700">‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•</div>
            </button>
            <button onclick="enterMode('admin')" class="group px-6 py-6 bg-white rounded-3xl border-2 border-orange-100 hover:border-orange-500 shadow-xl hover:shadow-2xl hover:-translate-y-1 transition-all duration-300 flex flex-col items-center">
                <div class="text-5xl mb-4 group-hover:scale-110 transition-transform">üéõÔ∏è</div>
                <div class="text-xl font-bold text-slate-700">‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£</div>
            </button>
            <button onclick="openTimer()" class="group px-6 py-6 bg-white rounded-3xl border-2 border-green-100 hover:border-green-500 shadow-xl hover:shadow-2xl hover:-translate-y-1 transition-all duration-300 flex flex-col items-center">
                <div class="text-5xl mb-4 group-hover:scale-110 transition-transform">‚è±Ô∏è</div>
                <div class="text-xl font-bold text-slate-700">‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤</div>
            </button>
            <button onclick="enterMode('sound')" class="group px-6 py-6 bg-white rounded-3xl border-2 border-purple-100 hover:border-purple-500 shadow-xl hover:shadow-2xl hover:-translate-y-1 transition-all duration-300 flex flex-col items-center">
                <div class="text-5xl mb-4 group-hover:scale-110 transition-transform">üéµ</div>
                <div class="text-xl font-bold text-slate-700">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢‡∏á</div>
            </button>
        </div>
    </div>

    <div id="display-view" class="hidden w-screen h-screen relative flex-col items-center justify-center overflow-hidden">
        <main class="responsive-container flex flex-col z-10 h-full max-h-screen relative gap-2 py-2">
            <header class="text-left relative flex flex-row justify-between items-end mb-1 flex-shrink-0 pt-2">
                <div class="flex-1">
                    <h1 id="display-title" class="text-responsive-title font-black text-white tracking-tight leading-none drop-shadow-lg">Townhall 2026</h1>
                    <div class="h-2 md:h-3 w-32 md:w-48 bg-gradient-to-r from-yellow-400 to-pink-500 mt-1 md:mt-2 rounded-full"></div>
                </div>
                <div class="pb-1 text-right">
                     <span class="text-responsive-target font-bold text-white/80 block">TARGET: <span class="text-white drop-shadow-md">1,300</span></span>
                </div>
            </header>

            <div id="ranking-list" class="flex-1 flex flex-col justify-center gap-2 md:gap-3 my-1 overflow-hidden">
            </div>
        </main>
    </div>

    <div id="admin-view" class="hidden w-full min-h-screen relative">
        <div class="responsive-container py-4">
            <div class="bg-white/95 backdrop-blur-md rounded-3xl shadow-sm border border-slate-200 p-4 mb-6 flex flex-col md:flex-row justify-between items-center sticky top-4 z-40 gap-4">
                <div class="flex items-center gap-2 w-full md:w-auto justify-between md:justify-start">
                    <h1 class="text-xl font-bold text-slate-800 flex items-center gap-2">‚öôÔ∏è ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°</h1>
                </div>
                
                <div class="flex gap-2 w-full md:w-auto">
                     <input type="text" id="main-title-input" class="flex-1 bg-slate-50 border border-slate-200 rounded-xl px-4 py-2 text-slate-700 text-center focus:ring-2 focus:ring-blue-500 outline-none font-bold text-lg transition-all" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°">
                    <button onclick="resetAll()" class="bg-red-50 text-red-600 border border-red-100 hover:bg-red-600 hover:text-white px-4 py-2 rounded-xl font-bold transition-all whitespace-nowrap">üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                </div>
            </div>

            <div id="admin-container" class="pb-10"></div>
        </div>
    </div>

    <!-- Sound Control View -->
    <div id="sound-view" class="hidden w-full min-h-screen relative">
        <div class="responsive-container py-4 max-w-4xl mx-auto">
            <!-- Header -->
            <div class="bg-white/95 backdrop-blur-md rounded-3xl shadow-sm border border-slate-200 p-6 mb-6 sticky top-4 z-40">
                <div class="flex items-center justify-between mb-4">
                    <h1 class="text-2xl md:text-3xl font-bold text-slate-800 flex items-center gap-3">
                        üéµ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢‡∏á
                    </h1>
                    <button onclick="backToModeSelector()" class="px-4 py-2 bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold rounded-xl transition-all">
                        ‚Üê ‡∏Å‡∏•‡∏±‡∏ö
                    </button>
                </div>
            </div>

            <!-- Volume Controls -->
            <div class="bg-white/95 backdrop-blur-md rounded-3xl shadow-sm border border-slate-200 p-6 mb-6">
                <h2 class="text-xl font-bold text-slate-700 mb-4 flex items-center gap-2">
                    üîä ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏£‡∏∞‡∏î‡∏±‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á
                </h2>
                
                <div class="space-y-4">
                    <!-- BGM Volume -->
                    <div class="bg-gradient-to-r from-purple-50 to-blue-50 p-4 rounded-2xl border border-purple-200">
                        <div class="flex items-center justify-between mb-3">
                            <label class="text-sm font-bold text-slate-700 flex items-center gap-2">
                                üéµ ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÄ‡∏û‡∏•‡∏á BGM
                            </label>
                            <button onclick="toggleMuteBGM()" id="mute-bgm-btn-sound" class="text-2xl hover:scale-110 transition-transform">üîä</button>
                        </div>
                        <input type="range" id="volume-bgm-slider-sound" min="0" max="1" step="0.05" value="0.5" 
                            class="w-full h-3 bg-gradient-to-r from-purple-200 to-blue-200 rounded-lg appearance-none cursor-pointer accent-purple-600" 
                            oninput="updateVolumeBGM(this.value)">
                        <div class="text-xs text-slate-500 mt-2 text-center">
                            Volume: <span id="bgm-volume-display">50</span>%
                        </div>
                    </div>

                    <!-- SFX Volume -->
                    <div class="bg-gradient-to-r from-orange-50 to-red-50 p-4 rounded-2xl border border-orange-200">
                        <div class="flex items-center justify-between mb-3">
                            <label class="text-sm font-bold text-slate-700 flex items-center gap-2">
                                üí• ‡πÄ‡∏™‡∏µ‡∏¢‡∏á ORA ORA
                            </label>
                            <button onclick="toggleMuteSFX()" id="mute-sfx-btn-sound" class="text-2xl hover:scale-110 transition-transform">üîä</button>
                        </div>
                        <input type="range" id="volume-sfx-slider-sound" min="0" max="1" step="0.05" value="0.5" 
                            class="w-full h-3 bg-gradient-to-r from-orange-200 to-red-200 rounded-lg appearance-none cursor-pointer accent-orange-600" 
                            oninput="updateVolumeSFX(this.value)">
                        <div class="text-xs text-slate-500 mt-2 text-center">
                            Volume: <span id="sfx-volume-display">50</span>%
                        </div>
                    </div>
                </div>
            </div>

            <!-- Event Sound Buttons -->
            <div class="bg-white/95 backdrop-blur-md rounded-3xl shadow-sm border border-slate-200 p-6">
                <h2 class="text-xl font-bold text-slate-700 mb-4 flex items-center gap-2">
                    üé™ ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
                </h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Champ 1 -->
                    <button id="btn-champ1" onclick="toggleEventSound('champ1')" 
                        class="sound-button bg-gradient-to-br from-yellow-400 to-orange-500 text-white p-8 rounded-3xl shadow-lg border-4 border-yellow-300 flex flex-col items-center gap-3 relative">
                        <div class="text-6xl">üèÜ</div>
                        <div class="text-xl font-black tracking-wide z-10">CHAMPION 1</div>
                        <div id="status-champ1" class="text-sm font-medium opacity-80 z-10">‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô</div>
                    </button>

                    <!-- Champ 2 -->
                    <button id="btn-champ2" onclick="toggleEventSound('champ2')" 
                        class="sound-button bg-gradient-to-br from-purple-500 to-pink-500 text-white p-8 rounded-3xl shadow-lg border-4 border-purple-300 flex flex-col items-center gap-3 relative">
                        <div class="text-6xl">üëë</div>
                        <div class="text-xl font-black tracking-wide z-10">CHAMPION 2</div>
                        <div id="status-champ2" class="text-sm font-medium opacity-80 z-10">‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô</div>
                    </button>

                    <!-- Open 1 -->
                    <button id="btn-open1" onclick="toggleEventSound('open1')" 
                        class="sound-button bg-gradient-to-br from-green-400 to-teal-500 text-white p-8 rounded-3xl shadow-lg border-4 border-green-300 flex flex-col items-center gap-3 relative">
                        <div class="text-6xl">üéâ</div>
                        <div class="text-xl font-black tracking-wide z-10">OPENING 1</div>
                        <div id="status-open1" class="text-sm font-medium opacity-80 z-10">‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô</div>
                    </button>

                    <!-- Open 2 -->
                    <button id="btn-open2" onclick="toggleEventSound('open2')" 
                        class="sound-button bg-gradient-to-br from-blue-400 to-indigo-500 text-white p-8 rounded-3xl shadow-lg border-4 border-blue-300 flex flex-col items-center gap-3 relative">
                        <div class="text-6xl">üéä</div>
                        <div class="text-xl font-black tracking-wide z-10">OPENING 2</div>
                        <div id="status-open2" class="text-sm font-medium opacity-80 z-10">‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô</div>
                    </button>
                </div>

                <div class="mt-6 p-4 bg-gradient-to-r from-slate-50 to-slate-100 rounded-2xl border border-slate-200">
                    <p class="text-sm text-slate-600 text-center">
                        üí° <strong>‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ:</strong> ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á ‡∏Å‡∏î‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏¢‡∏∏‡∏î
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const TARGET_SCORE = 1300;
        const EXCITED_THRESHOLD = 500; 
        
    const JOJO_CHARACTERS = [
            { name: 'b1', img: 'b1.png' },
            { name: 'b2', img: 'b2.png' },
            { name: 'b3', img: 'b3.png' },
            { name: 'b4', img: 'b4.png' },
            { name: 'b5', img: 'b5.png' },
            { name: 'b6', img: 'b6.png' },
            { name: 'b7', img: 'b7.png' },
            { name: 'b8', img: 'b8.png' },
            { name: 'b9', img: 'b9.png' },
            { name: 'b10', img: 'b10.png' },
            { name: 'b11', img: 'b11.png' },
            { name: 'b12', img: 'b12.png' },
            { name: 'b13', img: 'b13.png' },
            { name: 'b14', img: 'b14.png' },
            { name: 'b15', img: 'b15.png' },
            { name: 'b16', img: 'b16.png' },
            { name: 'b17', img: 'b17.png' },
            { name: 'b18', img: 'b18.png' },
            { name: 'b19', img: 'b19.png' },
            { name: 'b20', img: 'b20.png' }
        ];
        
        const COLOR_OPTIONS = [
            { name: 'üîµ OCEAN', color: 'text-blue-500', bg: 'bg-blue-500', border: 'border-blue-500', glow: 'drop-shadow(0 0 10px rgba(59, 130, 246, 1))' },
            { name: 'üü¢ EMERALD', color: 'text-green-600', bg: 'bg-green-500', border: 'border-green-500', glow: 'drop-shadow(0 0 10px rgba(34, 197, 94, 1))' },
            { name: 'üü† TANGERINE', color: 'text-orange-500', bg: 'bg-orange-500', border: 'border-orange-500', glow: 'drop-shadow(0 0 10px rgba(249, 115, 22, 1))' },
            { name: 'üü° GOLD', color: 'text-yellow-500', bg: 'bg-yellow-400', border: 'border-yellow-400', glow: 'drop-shadow(0 0 10px rgba(234, 179, 8, 1))' }
        ];
        
        const defaultData = [
            { id: 0, name: 'OCEAN', score: 0, count: 0, hasFinished: false, ...COLOR_OPTIONS[0], characterImg: 'b1.png' },
            { id: 1, name: 'EMERALD', score: 0, count: 0, hasFinished: false, ...COLOR_OPTIONS[1], characterImg: 'b2.png' },
            { id: 2, name: 'TANGERINE', score: 0, count: 0, hasFinished: false, ...COLOR_OPTIONS[2], characterImg: 'b3.png' },
            { id: 3, name: 'GOLD', score: 0, count: 0, hasFinished: false, ...COLOR_OPTIONS[3], characterImg: 'b4.png' }
        ];

        
        let teams = defaultData;
        let previousScores = {}; 
        let mainTitle = "Townhall 2026";
        let currentMode = '';
        let currentMusicState = 'none';
        let isFirebaseReady = false;
        let isFirstLoad = true;
        let audioSettings = { volumeBGM: 0.5, volumeSFX: 0.5, isMutedBGM: false, isMutedSFX: false };
        let shownUltimateTeams = {}; 

        let adminTeamSelection = null;

        const sfxScore = document.getElementById('sfx-score');
        const sfxDisplayHit = document.getElementById('sfx-display-hit');
        const sfxWin = document.getElementById('sfx-win');
        const sfxClick = document.getElementById('sfx-click');
        const sfxThunder = document.getElementById('sfx-thunder'); 
        const bgmNormal = document.getElementById('bgm-normal');
        const bgmExcited = document.getElementById('bgm-excited');

        // Event sounds
        const sfxChamp1 = document.getElementById('sfx-champ1');
        const sfxChamp2 = document.getElementById('sfx-champ2');
        const sfxOpen1 = document.getElementById('sfx-open1');
        const sfxOpen2 = document.getElementById('sfx-open2');

        sfxScore.volume = 0.5; 
        sfxDisplayHit.volume = 0.6; 
        sfxWin.volume = 0.5; 
        sfxClick.volume = 0.3; 
        sfxThunder.volume = 0.7;
        
        // Set event sound volumes
        sfxChamp1.volume = 0.7;
        sfxChamp2.volume = 0.7;
        sfxOpen1.volume = 0.7;
        sfxOpen2.volume = 0.7;
        
        bgmNormal.src = "https://raw.githubusercontent.com/noppadonpa-collab/townhall-2026/main/ss4%20Golden%20Wind.mp3";
        bgmExcited.src = "https://raw.githubusercontent.com/noppadonpa-collab/townhall-2026/main/Detective%20Conan%20Main%20Theme%20Captured%20In%20Her%20Eyes%20Version.mp3";

        function waitForFirebase() {
            return new Promise((resolve) => {
                const checkInterval = setInterval(() => {
                    if (window.firebaseDB && window.firebaseRef && window.firebaseOnValue && window.firebaseSet) {
                        clearInterval(checkInterval);
                        isFirebaseReady = true;
                        resolve();
                    }
                }, 100);
            });
        }

        async function loadFromFirebase() {
            await waitForFirebase();
            const teamsRef = window.firebaseRef(window.firebaseDB, 'teams');
            const titleRef = window.firebaseRef(window.firebaseDB, 'title');
            const audioRef = window.firebaseRef(window.firebaseDB, 'audioSettings');
            
            window.firebaseOnValue(teamsRef, (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    let cleanData = data;
                    if(data.length > 4) {
                         cleanData = data.slice(0, 4);
                    }

                    if (currentMode === 'display') {
                        let hasScoreIncreased = false;
                        cleanData.forEach((t, i) => {
                            const prevScore = previousScores[i] || 0;
                            if (t.score > prevScore) { hasScoreIncreased = true; }
                            if (t.score >= 500 && prevScore < 500 && !shownUltimateTeams[t.id]) {
                                triggerUltimateEffect(t);
                                shownUltimateTeams[t.id] = true;
                            }
                            if (t.score < 500) { shownUltimateTeams[t.id] = false; }
                        });
                        if (hasScoreIncreased && !isFirstLoad) { playSound('display_hit'); }
                    }

                    previousScores = cleanData.reduce((acc, t, i) => ({...acc, [i]: t.score}), {});
                    teams = cleanData;
                    renderDisplay();
                    renderAdmin();
                    isFirstLoad = false;
                } else {
                    teams = defaultData;
                    saveToFirebase();
                }
            });
            
            window.firebaseOnValue(titleRef, (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    mainTitle = data;
                    document.getElementById('display-title').innerText = mainTitle;
                    const titleInput = document.getElementById('main-title-input');
                    if(titleInput) titleInput.value = mainTitle;
                }
            });

            window.firebaseOnValue(audioRef, (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    audioSettings = data;
                    updateAudioFromSettings();
                    updateAdminAudioUI();
                }
            });
        }

        async function saveToFirebase() {
            if (!isFirebaseReady) return;
            await window.firebaseSet(window.firebaseRef(window.firebaseDB, 'teams'), teams);
            await window.firebaseSet(window.firebaseRef(window.firebaseDB, 'title'), mainTitle);
        }

        async function updateAudioSettings(newSettings) {
            if (!isFirebaseReady) return;
            await window.firebaseSet(window.firebaseRef(window.firebaseDB, 'audioSettings'), newSettings);
        }

        function playSound(type) {
            if (currentMode === 'admin' && type !== 'click') return;

            const audioMap = { 
                'score': sfxScore,
                'display_hit': sfxDisplayHit,
                'win': sfxWin, 
                'click': sfxClick,
                'thunder': sfxThunder
            };
            const audio = audioMap[type];
            if(audio) { 
                audio.currentTime = 0; 
                audio.play().catch(() => {}); 
            }
        }

        function updateAudioFromSettings() {
            const effectiveVolumeBGM = audioSettings.isMutedBGM ? 0 : audioSettings.volumeBGM;
            const effectiveVolumeSFX = audioSettings.isMutedSFX ? 0 : audioSettings.volumeSFX;
            
            sfxScore.volume = effectiveVolumeSFX;
            sfxDisplayHit.volume = effectiveVolumeSFX;
            sfxWin.volume = effectiveVolumeSFX;
            sfxThunder.volume = effectiveVolumeSFX;
            
            if (currentMode === 'display' || currentMode === 'sound') {
                bgmNormal.volume = effectiveVolumeBGM;
                bgmExcited.volume = effectiveVolumeBGM;
            } else {
                bgmNormal.volume = 0;
                bgmExcited.volume = 0;
                bgmNormal.pause();
                bgmExcited.pause();
            }
        }

        function updateAdminAudioUI() {
            // Update sound view UI
            const muteBGMBtnSound = document.getElementById('mute-bgm-btn-sound');
            const muteSFXBtnSound = document.getElementById('mute-sfx-btn-sound');
            const sliderBGMSound = document.getElementById('volume-bgm-slider-sound');
            const sliderSFXSound = document.getElementById('volume-sfx-slider-sound');
            const bgmVolumeDisplay = document.getElementById('bgm-volume-display');
            const sfxVolumeDisplay = document.getElementById('sfx-volume-display');
            
            if(muteBGMBtnSound && sliderBGMSound && bgmVolumeDisplay) {
                muteBGMBtnSound.innerHTML = audioSettings.isMutedBGM ? 'üîá' : 'üîä';
                sliderBGMSound.value = audioSettings.volumeBGM;
                bgmVolumeDisplay.textContent = Math.round(audioSettings.volumeBGM * 100);
            }
            if(muteSFXBtnSound && sliderSFXSound && sfxVolumeDisplay) {
                muteSFXBtnSound.innerHTML = audioSettings.isMutedSFX ? 'üîá' : 'üîä';
                sliderSFXSound.value = audioSettings.volumeSFX;
                sfxVolumeDisplay.textContent = Math.round(audioSettings.volumeSFX * 100);
            }
        }

        function toggleMuteBGM() {
            const newSettings = { ...audioSettings, isMutedBGM: !audioSettings.isMutedBGM };
            updateAudioSettings(newSettings);
        }

        function toggleMuteSFX() {
            const newSettings = { ...audioSettings, isMutedSFX: !audioSettings.isMutedSFX };
            updateAudioSettings(newSettings);
        }

        function updateVolumeBGM(val) {
            const newSettings = { ...audioSettings, volumeBGM: parseFloat(val), isMutedBGM: false };
            updateAudioSettings(newSettings);
            const display = document.getElementById('bgm-volume-display');
            if(display) display.textContent = Math.round(parseFloat(val) * 100);
        }

        function updateVolumeSFX(val) {
            const newSettings = { ...audioSettings, volumeSFX: parseFloat(val), isMutedSFX: false };
            updateAudioSettings(newSettings);
            const display = document.getElementById('sfx-volume-display');
            if(display) display.textContent = Math.round(parseFloat(val) * 100);
        }

        function checkAndUpdateMusic() {
            if(currentMode !== 'display') return;
            const maxScore = Math.max(...teams.map(t => t.score));
            const targetState = maxScore >= EXCITED_THRESHOLD ? 'excited' : 'normal';

            if(currentMusicState !== targetState) {
                if(targetState === 'excited') {
                    bgmNormal.pause();
                    bgmExcited.currentTime = 0;
                    bgmExcited.play().catch(() => {});
                } else {
                    bgmExcited.pause();
                    if(bgmNormal.paused) { bgmNormal.play().catch(() => {}); }
                }
                currentMusicState = targetState;
            } else {
                if (targetState === 'normal' && bgmNormal.paused) { bgmNormal.play().catch(() => {}); }
            }
        }

        function createBackgroundDecoration() {
            const container = document.getElementById('bg-decorations');
            container.innerHTML = '';
            for(let i = 0; i < 30; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                star.style.left = Math.random() * 100 + '%';
                star.style.top = Math.random() * 100 + '%';
                star.style.width = (Math.random() * 15 + 10) + 'px';
                star.style.height = star.style.width;
                star.style.animationDelay = Math.random() * 3 + 's';
                container.appendChild(star);
            }
            setInterval(() => { if(currentMode === 'display') createFirework(); }, 3000);
        }

        function createFirework() {
            const colors = ['#ff6b6b', '#4ecdc4', '#45b7d1', '#f9ca24', '#ee5a6f', '#c44569'];
            const x = Math.random() * window.innerWidth;
            const y = Math.random() * (window.innerHeight * 0.6);
            for(let i = 0; i < 20; i++) {
                const particle = document.createElement('div');
                particle.className = 'firework-particle';
                particle.style.left = x + 'px';
                particle.style.top = y + 'px';
                particle.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                const angle = (Math.PI * 2 * i) / 20;
                const distance = 50 + Math.random() * 100;
                particle.style.setProperty('--tx', Math.cos(angle) * distance + 'px');
                particle.style.setProperty('--ty', Math.sin(angle) * distance + 'px');
                document.body.appendChild(particle);
                setTimeout(() => particle.remove(), 1300);
            }
        }

        function triggerUltimateEffect(team) {
            if (currentMode !== 'display') return;

            const overlay = document.getElementById('ultimate-overlay');
            const img = document.getElementById('ultimate-img');
            
            if(overlay && img) {
                img.src = team.characterImg;
                overlay.classList.remove('hidden');
                overlay.style.opacity = '1';
                
                playSound('thunder'); 

                const charDiv = document.getElementById('effect-char');
                const flashDiv = document.getElementById('effect-flash');
                charDiv.style.animation = 'none';
                charDiv.offsetHeight; 
                charDiv.style.animation = 'cutInAnim 1.2s cubic-bezier(0.17, 0.67, 0.83, 0.67) forwards';
                
                flashDiv.style.animation = 'none';
                flashDiv.offsetHeight;
                flashDiv.style.animation = 'flashAnim 0.8s ease-out forwards';

                setTimeout(() => {
                    overlay.style.opacity = '0';
                    setTimeout(() => { overlay.classList.add('hidden'); }, 200);
                }, 1500);
            }
        }

        function openTimer() {
            window.open('timer.html', '_blank');
        }

        function backToModeSelector() {
            currentMode = '';
            document.getElementById('sound-view').classList.add('hidden');
            document.getElementById('mode-selector').classList.remove('hidden');
            
            // Stop all event sounds
            stopAllEventSounds();
            
            // Stop BGM
            bgmNormal.pause();
            bgmExcited.pause();
            
            document.body.classList.remove('mode-sound');
        }

        function enterMode(mode) {
            currentMode = mode;
            document.getElementById('mode-selector').classList.add('hidden');
            
            if(mode === 'display') {
                document.body.classList.add('mode-display');
                document.body.classList.remove('mode-admin', 'mode-sound');
                document.getElementById('display-view').classList.remove('hidden');
                document.getElementById('display-view').classList.add('flex');
                document.getElementById('admin-view').classList.add('hidden');
                document.getElementById('sound-view').classList.add('hidden');
                
                playSound('click');
                sfxDisplayHit.volume = 0.01;
                sfxDisplayHit.play().then(() => {
                    sfxDisplayHit.pause();
                    sfxDisplayHit.currentTime = 0;
                    sfxDisplayHit.volume = 0.6;
                }).catch(() => {});

                createBackgroundDecoration();
                checkAndUpdateMusic();
                renderDisplay();
            } else if(mode === 'admin') {
                document.body.classList.add('mode-admin');
                document.body.classList.remove('mode-display', 'mode-sound');
                document.getElementById('admin-view').classList.remove('hidden');
                document.getElementById('display-view').classList.add('hidden');
                document.getElementById('sound-view').classList.add('hidden');
                
                bgmNormal.pause();
                bgmExcited.pause();
                playSound('click');
                
                adminTeamSelection = null; 
                renderAdmin();
                updateAdminAudioUI();
            } else if(mode === 'sound') {
                document.body.classList.add('mode-sound');
                document.body.classList.remove('mode-display', 'mode-admin');
                document.getElementById('sound-view').classList.remove('hidden');
                document.getElementById('display-view').classList.add('hidden');
                document.getElementById('admin-view').classList.add('hidden');
                
                playSound('click');
                updateAdminAudioUI();
                updateAudioFromSettings();
            }
        }

        function renderDisplay() {
            if(document.getElementById('display-view').classList.contains('hidden')) return;
            document.getElementById('display-title').innerText = mainTitle;
            renderAllInOneCards();
            checkAndUpdateMusic();
        }

        function renderAllInOneCards() {
            const container = document.getElementById('ranking-list');
            const sortedTeams = [...teams].sort((a, b) => b.score - a.score);

            container.innerHTML = sortedTeams.map((t, rankIndex) => {
                const percent = Math.min(100, (t.score / TARGET_SCORE) * 100);
                const rank = rankIndex + 1;
                let rankDisplay = '';
                let containerClass = 'bg-white/95 border-slate-200 backdrop-blur-sm';
                
                if(rank === 1) {
                    rankDisplay = `<div class="text-responsive-rank mr-2 md:mr-6 medal-icon drop-shadow-lg leading-none">ü•á</div>`;
                    containerClass = 'bg-gradient-to-r from-yellow-100/95 via-white/95 to-yellow-50/95 border-yellow-400 backdrop-blur-sm';
                } else if(rank === 2) {
                    rankDisplay = `<div class="text-responsive-rank mr-2 md:mr-6 medal-icon drop-shadow-lg leading-none" style="animation-delay: 0.5s">ü•à</div>`;
                    containerClass = 'bg-gradient-to-r from-slate-100/95 via-white/95 to-slate-50/95 border-slate-300 backdrop-blur-sm';
                } else if(rank === 3) {
                    rankDisplay = `<div class="text-responsive-rank mr-2 md:mr-6 medal-icon drop-shadow-lg leading-none" style="animation-delay: 1s">ü•â</div>`;
                    containerClass = 'bg-gradient-to-r from-orange-100/95 via-white/95 to-orange-50/95 border-orange-300 backdrop-blur-sm';
                } else {
                    rankDisplay = `<div class="text-responsive-rank font-black text-slate-300 mr-2 md:mr-6 w-16 md:w-24 text-center leading-none">#${rank}</div>`;
                }

                const mascotLeft = `calc(${percent}% - 3rem)`; 

                return `
                <div id="main-card-${t.id}" class="ranking-card w-full ${containerClass} rounded-[2rem] border-[3px] shadow-2xl flex items-center justify-between transition-all duration-500 relative overflow-visible h-full max-h-[22vh]">
                    
                    <div class="flex items-center z-10 w-full md:w-[50%] lg:w-[45%] overflow-hidden">
                        <div class="flex-shrink-0">${rankDisplay}</div>
                        
                        <div class="flex items-center gap-2 md:gap-4 flex-1 min-w-0 pr-2">
                            <img src="${t.characterImg}" alt="${t.name}" class="w-12 h-12 md:w-16 md:h-16 lg:w-20 lg:h-20 object-contain filter drop-shadow-lg flex-shrink-0" onerror="this.style.display='none'">
                            <span class="font-extrabold text-slate-800 text-responsive-name tracking-tight leading-none drop-shadow-sm break-words">${t.name}</span>
                        </div>
                    </div>

                    <div class="flex flex-col justify-center z-10 h-full relative score-section w-full md:w-[50%] lg:w-[55%] pl-2">
                        <div class="text-right mb-0 md:mb-1 pr-12 md:pr-16 lg:pr-20">
                            <span id="score-text-${t.id}" class="font-black ${t.color} text-responsive-score leading-none filter drop-shadow-lg score-anim block">${t.score}</span>
                        </div>
                        <div class="progress-container-custom">
                            <div class="absolute inset-0 bg-slate-200/50 rounded-full"></div>
                            <div class="finish-tape-in-bar"></div>
                            <div id="progress-fill-${t.id}" class="progress-fill-custom ${t.bg}" style="width: ${percent}%"></div>
                            <div id="mascot-runner-${t.id}" class="mascot-on-bar" style="left: ${mascotLeft}; filter: ${t.glow}">
                                <span class="relative block"><img src="${t.characterImg}" alt="${t.name}" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2280%22 height=%2280%22%3E%3Ctext y=%2260%22 font-size=%2260%22%3E‚ùì%3C/text%3E%3C/svg%3E'"></span>
                            </div>
                            <div id="confetti-point-${t.id}" class="absolute top-0 bottom-0 right-2 w-1 pointer-events-none"></div>
                        </div>
                    </div>
                </div>`;
            }).join('');

            setTimeout(() => {
                sortedTeams.forEach((t) => {
                    const mascotEl = document.getElementById(`mascot-runner-${t.id}`);
                    const scoreEl = document.getElementById(`score-text-${t.id}`);
                    const confettiPoint = document.getElementById(`confetti-point-${t.id}`);
                    const percent = Math.min(100, (t.score / TARGET_SCORE) * 100);

                    if (percent >= 100) {
                        if (!mascotEl.classList.contains('winner-mascot')) {
                             mascotEl.classList.add('winner-mascot');
                             mascotEl.innerHTML = `<div class="winner-badge-mini"><span class="winner-crown-mini">üëë</span></div><span class="relative block"><img src="${t.characterImg}" alt="${t.name}" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2280%22 height=%2280%22%3E%3Ctext y=%2260%22 font-size=%2260%22%3E‚ùì%3C/text%3E%3C/svg%3E'"></span>`;
                        }
                        if (!t.hasFinished) {
                            t.hasFinished = true;
                            saveToFirebase();
                            playSound('win');
                            triggerMiniConfetti(confettiPoint, t.bg.replace('bg-', ''));
                        }
                    } else {
                        mascotEl.classList.remove('winner-mascot');
                        mascotEl.innerHTML = `<span class="relative block"><img src="${t.characterImg}" alt="${t.name}" onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%2280%22 height=%2280%22%3E%3Ctext y=%2260%22 font-size=%2260%22%3E‚ùì%3C/text%3E%3C/svg%3E'"></span>`;
                        if(t.hasFinished) { t.hasFinished = false; saveToFirebase(); }
                    }
                    scoreEl.classList.remove('pop');
                    void scoreEl.offsetWidth;
                    scoreEl.classList.add('pop');
                });
            }, 50);
        }

        function triggerMiniConfetti(element, colorName) {
            if(!element) return;
            const colorsMap = { 'red-500': '#ef4444', 'blue-500': '#3b82f6', 'green-500': '#22c55e', 'yellow-400': '#eab308', 'purple-500': '#a855f7', 'pink-500': '#ec4899', 'orange-500': '#f97316', 'teal-500': '#14b8a6' };
            const colorHex = colorsMap[colorName] || '#ffd700';
            for(let i=0; i<20; i++) {
                const el = document.createElement('div');
                el.className = 'confetti-finish';
                el.style.backgroundColor = colorHex;
                el.style.top = '50%'; el.style.left = '50%';
                const angle = Math.random() * Math.PI * 2;
                const distance = 40 + Math.random() * 60;
                el.style.setProperty('--tx', Math.cos(angle) * distance + 'px');
                el.style.setProperty('--ty', Math.sin(angle) * distance + 'px');
                element.appendChild(el);
                setTimeout(() => el.remove(), 1300);
            }
        }

        // Event Sound Management
        let currentPlayingSound = null;

        function stopAllEventSounds() {
            [sfxChamp1, sfxChamp2, sfxOpen1, sfxOpen2].forEach(audio => {
                audio.pause();
                audio.currentTime = 0;
            });
            
            // Reset all button states
            ['champ1', 'champ2', 'open1', 'open2'].forEach(id => {
                const btn = document.getElementById(`btn-${id}`);
                const status = document.getElementById(`status-${id}`);
                if(btn) btn.classList.remove('playing');
                if(status) status.textContent = '‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô';
            });
            
            currentPlayingSound = null;
        }

        function toggleEventSound(soundId) {
            const audioMap = {
                'champ1': sfxChamp1,
                'champ2': sfxChamp2,
                'open1': sfxOpen1,
                'open2': sfxOpen2
            };
            
            const audio = audioMap[soundId];
            const btn = document.getElementById(`btn-${soundId}`);
            const status = document.getElementById(`status-${soundId}`);
            
            if (!audio || !btn || !status) return;
            
            // If this sound is currently playing, stop it
            if (currentPlayingSound === soundId) {
                audio.pause();
                audio.currentTime = 0;
                btn.classList.remove('playing');
                status.textContent = '‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô';
                currentPlayingSound = null;
            } else {
                // Stop any currently playing sound
                stopAllEventSounds();
                
                // Play the new sound
                audio.currentTime = 0;
                audio.play().catch(() => {});
                btn.classList.add('playing');
                status.textContent = 'üîä ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏•‡πà‡∏ô...';
                currentPlayingSound = soundId;
                
                // When sound ends, reset button state
                audio.onended = () => {
                    btn.classList.remove('playing');
                    status.textContent = '‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô';
                    currentPlayingSound = null;
                };
            }
        }

        function generateAdminHTML(t, i) {
            return `
                <div class="mb-4 text-center">
                    <button onclick="adminTeamSelection = null; renderAdmin();" class="px-6 py-2 bg-slate-200 hover:bg-slate-300 text-slate-700 font-bold rounded-xl transition-all">‚¨ÖÔ∏è ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏µ‡∏°</button>
                </div>
                <div id="admin-card-${i}" class="bg-white rounded-3xl p-4 md:p-6 shadow-2xl border-[4px] ${t.border} max-w-2xl mx-auto">
                    <div class="flex items-center gap-4 mb-4 md:mb-6">
                        <div class="text-4xl md:text-5xl bg-slate-50 p-3 md:p-4 rounded-2xl flex-shrink-0">
                            <img id="admin-head-img-${i}" src="${t.characterImg}" alt="${t.name}" class="w-12 h-12 md:w-16 md:h-16 object-contain" onerror="this.style.display='none'">
                        </div>
                        <div class="flex-1 min-w-0">
                            <input id="admin-name-${i}" type="text" value="${t.name}" onchange="updateName(${i}, this.value)" class="text-xl md:text-3xl font-bold text-slate-800 bg-transparent border-b-2 border-transparent focus:border-blue-500 outline-none w-full mb-2">
                        </div>
                    </div>
                    
                    <div class="mb-4">
                        <div class="text-sm font-bold text-slate-600 mb-2">‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£ JOJO:</div>
                        <div class="character-grid max-h-48 md:max-h-60 overflow-y-auto p-2 bg-slate-50 rounded-xl custom-scrollbar">
                            ${JOJO_CHARACTERS.map(char => `
                                <div class="character-option ${t.characterImg === char.img ? 'selected' : ''}" onclick="updateCharacter(${i}, '${char.img}')">
                                    <img src="${char.img}" alt="${char.name}" onerror="this.parentElement.style.display='none'">
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <div class="flex justify-between items-end mb-4 md:mb-6">
                        <div><div class="text-xs text-slate-400 uppercase font-bold tracking-wider">Score</div><div id="admin-score-${i}" class="text-5xl md:text-6xl font-extrabold ${t.color}">${t.score}</div></div>
                         <div class="text-right"><div class="text-xs text-slate-400 uppercase font-bold tracking-wider">Status</div><div id="admin-status-${i}" class="text-base md:text-lg font-bold ${t.hasFinished ? 'text-green-500' : 'text-slate-400'}">${t.hasFinished ? 'FINISHED üèÅ' : 'Racing...'}</div></div>
                    </div>
                    
                  <div class="flex flex-col gap-4 mb-4">
    <div class="grid grid-cols-4 gap-2">
        <button onclick="addScore(${i}, 20)" class="py-3 rounded-xl bg-slate-100 hover:bg-green-50 text-slate-700 hover:text-green-600 font-bold border border-slate-200 transition-all text-lg">+20</button>
        <button onclick="addScore(${i}, 40)" class="py-3 rounded-xl bg-slate-100 hover:bg-green-50 text-slate-700 hover:text-green-600 font-bold border border-slate-200 transition-all text-lg">+40</button>
        <button onclick="addScore(${i}, 60)" class="py-3 rounded-xl bg-slate-100 hover:bg-green-50 text-slate-700 hover:text-green-600 font-bold border border-slate-200 transition-all text-lg">+60</button>
        <button onclick="addScore(${i}, 80)" class="py-3 rounded-xl bg-slate-100 hover:bg-green-50 text-slate-700 hover:text-green-600 font-bold border border-slate-200 transition-all text-lg">+80</button>
    </div>

    <div class="grid grid-cols-4 gap-2">
        <button onclick="addScore(${i}, 25)" class="py-4 rounded-xl bg-slate-100 hover:bg-green-100 text-slate-700 hover:text-green-700 font-bold border border-slate-200 transition-all text-xl">+25</button>
        <button onclick="addScore(${i}, 50)" class="py-4 rounded-xl bg-slate-100 hover:bg-green-100 text-slate-700 hover:text-green-700 font-bold border border-slate-200 transition-all text-xl">+50</button>
        <button onclick="addScore(${i}, 75)" class="py-4 rounded-xl bg-slate-100 hover:bg-green-100 text-slate-700 hover:text-green-700 font-bold border border-slate-200 transition-all text-xl">+75</button>
        <button onclick="addScore(${i}, 100)" class="py-4 rounded-xl bg-green-600 hover:bg-green-700 text-white font-bold shadow-md shadow-green-200 transition-all text-2xl">+100</button>
    </div>

    <hr class="border-slate-100">

    <div class="grid grid-cols-4 gap-2">
        <button onclick="addScore(${i}, -20)" class="py-2 rounded-xl bg-slate-50 hover:bg-red-50 text-slate-400 hover:text-red-400 font-medium border border-slate-200 text-base">-20</button>
        <button onclick="addScore(${i}, -40)" class="py-2 rounded-xl bg-slate-50 hover:bg-red-50 text-slate-400 hover:text-red-400 font-medium border border-slate-200 text-base">-40</button>
        <button onclick="addScore(${i}, -60)" class="py-2 rounded-xl bg-slate-50 hover:bg-red-50 text-slate-400 hover:text-red-400 font-medium border border-slate-200 text-base">-60</button>
        <button onclick="addScore(${i}, -80)" class="py-2 rounded-xl bg-slate-50 hover:bg-red-50 text-slate-400 hover:text-red-400 font-medium border border-slate-200 text-base">-80</button>
    </div>

    <div class="grid grid-cols-4 gap-2">
        <button onclick="addScore(${i}, -25)" class="py-2 rounded-xl bg-slate-50 hover:bg-red-50 text-slate-400 hover:text-red-500 font-medium border border-slate-200 text-base">-25</button>
        <button onclick="addScore(${i}, -50)" class="py-2 rounded-xl bg-slate-50 hover:bg-red-50 text-slate-400 hover:text-red-500 font-medium border border-slate-200 text-base">-50</button>
        <button onclick="addScore(${i}, -75)" class="py-2 rounded-xl bg-slate-50 hover:bg-red-50 text-slate-400 hover:text-red-500 font-medium border border-slate-200 text-base">-75</button>
        <button onclick="addScore(${i}, -100)" class="py-2 rounded-xl bg-red-500 hover:bg-red-600 text-white font-bold shadow-md shadow-red-200 transition-all text-lg">-100</button>
    </div>
</div>

<div class="pt-4 border-t border-slate-100">
    <button onclick="resetTeam(${i})" class="w-full py-2 text-slate-400 hover:text-red-500 text-sm font-medium transition-colors">üîÑ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ó‡∏µ‡∏°‡∏ô‡∏µ‡πâ</button>
</div>
            `;
        }

        function renderAdmin() {
            if(document.getElementById('admin-view').classList.contains('hidden')) return;
            
            const titleInput = document.getElementById('main-title-input');
            if (titleInput && document.activeElement !== titleInput) {
                titleInput.value = mainTitle;
            }

            const container = document.getElementById('admin-container');
            
            if (adminTeamSelection === null) {
                container.className = "grid grid-cols-1 md:grid-cols-2 gap-6 max-w-4xl mx-auto mt-8";
                container.innerHTML = teams.map((t, i) => `
                    <button onclick="selectAdminTeam(${i})" class="group relative overflow-hidden bg-white rounded-3xl p-8 border-[4px] ${t.border} shadow-lg hover:shadow-2xl hover:-translate-y-2 transition-all duration-300 text-left">
                        <div class="absolute right-0 top-0 w-32 h-32 bg-current opacity-5 rounded-full -mr-10 -mt-10 ${t.color}"></div>
                        <div class="flex items-center gap-6 relative z-10">
                            <img src="${t.characterImg}" class="w-20 h-20 object-contain drop-shadow-md group-hover:scale-110 transition-transform">
                            <div>
                                <div class="text-sm font-bold text-slate-400 mb-1">TEAM</div>
                                <div class="text-3xl font-black ${t.color} uppercase tracking-tight">${t.name}</div>
                                <div class="text-slate-500 font-medium mt-2">Score: <span class="text-slate-800 font-bold text-xl">${t.score}</span></div>
                            </div>
                        </div>
                        <div class="absolute bottom-4 right-6 text-slate-300 group-hover:text-slate-400 font-bold flex items-center gap-2">
                            ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏° <span class="text-xl">‚Üí</span>
                        </div>
                    </button>
                `).join('');
            } else {
                container.className = "w-full pb-10";
                const existingCard = document.getElementById(`admin-card-${adminTeamSelection}`);
                
                if (!existingCard) {
                    container.innerHTML = generateAdminHTML(teams[adminTeamSelection], adminTeamSelection);
                } else {
                    const i = adminTeamSelection;
                    const t = teams[i];
                    
                    const scoreEl = document.getElementById(`admin-score-${i}`);
                    if (scoreEl && scoreEl.innerText !== t.score.toString()) { scoreEl.innerText = t.score; }

                    const statusEl = document.getElementById(`admin-status-${i}`);
                    if(statusEl) {
                        const statusText = t.hasFinished ? 'FINISHED üèÅ' : 'Racing...';
                        if(statusEl.innerText !== statusText) {
                            statusEl.innerText = statusText;
                            statusEl.className = `text-base md:text-lg font-bold ${t.hasFinished ? 'text-green-500' : 'text-slate-400'}`;
                        }
                    }
                    const nameInput = document.getElementById(`admin-name-${i}`);
                    if (nameInput && document.activeElement !== nameInput && nameInput.value !== t.name) { nameInput.value = t.name; }
                    
                    const headImg = document.getElementById(`admin-head-img-${i}`);
                    if (headImg && headImg.getAttribute('src') !== t.characterImg) { headImg.src = t.characterImg; }
                }
            }
        }

        window.selectAdminTeam = function(index) {
            playSound('click');
            adminTeamSelection = index;
            renderAdmin();
        }

        function addScore(index, val) {
            playSound('score'); 
            
            teams[index].score += val;
            if(teams[index].score < 0) teams[index].score = 0;
            if(teams[index].score > TARGET_SCORE) teams[index].score = TARGET_SCORE; 
            teams[index].count++;
            
            const diff = val;
            if (diff > 0) {
                const card = document.getElementById(`main-card-${teams[index].id}`);
                if(card) {
                    const el = document.createElement('div');
                    el.className = 'floating-score';
                    el.classList.add(teams[index].color);
                    el.innerText = '+' + diff;
                    card.appendChild(el);
                    setTimeout(() => el.remove(), 1300);
                }
            }
            saveToFirebase();
        }

        function updateName(index, val) { teams[index].name = val; saveToFirebase(); renderDisplay(); }
        function updateCharacter(index, charImg) { 
            teams[index].characterImg = charImg; 
            saveToFirebase(); 
            renderAdmin(); 
            renderDisplay(); 
        }
        function resetTeam(index) { if(confirm('‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏µ‡∏°‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô 0?')) { teams[index].score = 0; teams[index].count = 0; teams[index].hasFinished = false; saveToFirebase(); renderAdmin(); renderDisplay(); } }
        
        function resetAll() { 
            if(confirm('‚ö†Ô∏è ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÅ‡∏•‡∏∞‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ó‡∏µ‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?\n(‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡∏°‡πÅ‡∏•‡∏∞‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÉ‡∏´‡∏°‡πà)')) { 
                teams = JSON.parse(JSON.stringify(defaultData)); 
                saveToFirebase(); 
                adminTeamSelection = null; 
                renderAdmin(); 
                renderDisplay(); 
            } 
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadFromFirebase();
            const titleInput = document.getElementById('main-title-input');
            if(titleInput) {
                titleInput.addEventListener('input', (e) => {
                    mainTitle = e.target.value; 
                    saveToFirebase();
                    document.getElementById('display-title').innerText = mainTitle;
                });
            }
        });
    </script>
</body>
</html>

