<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scoreboard System (Townhall 2026)</title>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Prompt', 'sans-serif'] },
                    colors: { slate: { 50: '#f8fafc', 100: '#f1f5f9', 200: '#e2e8f0', 800: '#1e293b', 900: '#0f172a' } }
                }
            }
        }
    </script>
    <style>
        body { background-color: #f8fafc; color: #1e293b; overflow: hidden; }
        
        /* ‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ó‡∏µ‡∏° (‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡∏ß‡∏≤) */
        .display-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255,255,255,0.5);
            box-shadow: 0 4px 15px -3px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* Animation ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÄ‡∏î‡πâ‡∏á */
        .score-anim { transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .score-anim.pop { transform: scale(1.3); }

        /* ‡∏´‡∏•‡∏≠‡∏î‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô */
        .progress-track {
            background-color: #f1f5f9;
            border-radius: 999px;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
        }
        .progress-bar {
            height: 100%;
            border-radius: 999px;
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        .progress-bar::after {
            content: '';
            position: absolute;
            top: 0; left: 0; bottom: 0; right: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            transform: translateX(-100%);
            animation: shimmer 2.5s infinite;
        }
        @keyframes shimmer { 100% { transform: translateX(100%); } }

        /* ‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡∏•‡∏≠‡∏¢ (Ranking) */
        @keyframes medalFloat {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }
        .medal-icon { animation: medalFloat 3s ease-in-out infinite; }

        /* ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏•‡∏≠‡∏¢ (+100) */
        @keyframes floatUpFade {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(-40px) scale(1.2); }
        }
        .floating-score {
            position: absolute;
            font-size: 2.5rem; 
            font-weight: 900;
            animation: floatUpFade 1.2s ease-out forwards;
            pointer-events: none;
            z-index: 50;
            text-shadow: 0 4px 10px rgba(255,255,255,0.9);
            -webkit-text-stroke: 1px white;
            right: 20px;
            top: 50%;
        }

        /* Confetti ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ */
        .confetti-general {
            position: fixed; width: 12px; height: 12px;
            z-index: 100;
            animation: confettiFall 2.5s linear forwards;
            pointer-events: none;
        }
        @keyframes confettiFall {
            to { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }

        /* Scrollbar ‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏ß‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏° */
        .custom-scrollbar::-webkit-scrollbar { width: 0px; background: transparent; }

        /* --- Styles ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Mascot Race --- */
        #racetrack-wrapper {
            background: linear-gradient(to bottom, #f8fafc, #e2e8f0);
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.05);
        }
        .finish-line-tape {
            background-image: 
                linear-gradient(45deg, #334155 25%, transparent 25%), 
                linear-gradient(-45deg, #334155 25%, transparent 25%), 
                linear-gradient(45deg, transparent 75%, #334155 75%), 
                linear-gradient(-45deg, transparent 75%, #334155 75%);
            background-size: 16px 16px;
            background-position: 0 0, 0 8px, 8px -8px, -8px 0px;
            opacity: 0.8;
            border-left: 2px dashed rgba(255,255,255,0.5);
        }
        
        /* ‡∏´‡∏≠‡∏¢‡∏ó‡∏≤‡∏Å‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô */
        .snail-racer {
            position: absolute;
            left: 0;
            bottom: 5px; /* ‡∏õ‡∏£‡∏±‡∏ö‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤‡∏ô‡∏¥‡∏î‡∏´‡∏ô‡πà‡∏≠‡∏¢‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡∏à‡∏° */
            font-size: 3rem; /* ‡∏Ç‡∏ô‡∏≤‡∏î‡πÉ‡∏´‡∏ç‡πà‡∏Ç‡∏∂‡πâ‡∏ô */
            transition: left 1s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 20;
            transform: scaleX(-1);
            filter: drop-shadow(4px 4px 8px rgba(0,0,0,0.3)); /* ‡πÄ‡∏á‡∏≤‡∏ä‡∏±‡∏î‡∏Ç‡∏∂‡πâ‡∏ô */
        }
        
        /* ‡∏ó‡πà‡∏≤‡∏ó‡∏≤‡∏á‡∏î‡∏µ‡πÉ‡∏à‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÄ‡∏™‡πâ‡∏ô‡∏ä‡∏±‡∏¢ */
        @keyframes happyBounce {
            0%, 100% { transform: scaleX(-1) translateY(0) scaleY(1); }
            50% { transform: scaleX(-1) translateY(-15px) scaleY(1.15); }
        }
        .winner-snail { animation: happyBounce 0.6s ease-in-out infinite; }
        
        .winner-badge-container {
             transform: scaleX(-1);
             position: absolute;
             top: -35px;
             left: 50%;
             transform: translateX(-50%) scaleX(-1);
             display: flex;
             flex-direction: column;
             align-items: center;
        }
        .winner-crown { font-size: 1.8rem; animation: medalFloat 2s ease-in-out infinite; }
        .finished-text {
            font-size: 0.7rem; font-weight: 800; color: #fff; background-color: #22c55e;
            padding: 2px 6px; border-radius: 4px; white-space: nowrap; margin-top: -4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        /* Confetti ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏à‡∏∏‡∏î‡πÄ‡∏™‡πâ‡∏ô‡∏ä‡∏±‡∏¢ */
        .confetti-finish {
            position: absolute; width: 8px; height: 8px; z-index: 30;
            border-radius: 50%; animation: finishExplosion 1.5s ease-out forwards; pointer-events: none;
        }
        @keyframes finishExplosion {
            0% { transform: translate(0, 0) scale(1); opacity: 1; }
            80% { opacity: 1; }
            100% { transform: translate(var(--tx), var(--ty)) scale(0.5); opacity: 0; }
        }
    </style>
</head>
<body class="h-screen overflow-hidden flex flex-col">

    <audio id="sfx-score" src="https://assets.mixkit.co/active_storage/sfx/2578/2578-preview.mp3"></audio>
    <audio id="sfx-win" src="https://assets.mixkit.co/active_storage/sfx/1435/1435-preview.mp3"></audio>
    <audio id="sfx-click" src="https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3"></audio>
    
    <audio id="bgm-normal" loop src="https://assets.mixkit.co/active_storage/stock_music/904/904-preview.mp3"></audio>
    <audio id="bgm-excited" loop src="https://assets.mixkit.co/active_storage/stock_music/112/112-preview.mp3"></audio>

    <div id="mode-selector" class="fixed inset-0 z-50 bg-slate-50 flex flex-col items-center justify-center space-y-8">
        <div class="text-center space-y-2">
            <h1 class="text-6xl font-bold text-slate-800 drop-shadow-sm">üèÜ ‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏±‡∏ö‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô Townhall 2026</h1>
            <p class="text-slate-400 text-lg">*‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á</p>
        </div>
        <div class="flex gap-8">
            <button onclick="enterMode('display')" class="group px-10 py-8 bg-white rounded-3xl border-2 border-blue-100 hover:border-blue-500 shadow-xl hover:shadow-2xl hover:-translate-y-1 transition-all duration-300 w-80">
                <div class="text-6xl mb-4 group-hover:scale-110 transition-transform">üì∫</div>
                <div class="text-2xl font-bold text-slate-700">‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•</div>
            </button>
            <button onclick="enterMode('admin')" class="group px-10 py-8 bg-white rounded-3xl border-2 border-orange-100 hover:border-orange-500 shadow-xl hover:shadow-2xl hover:-translate-y-1 transition-all duration-300 w-80">
                <div class="text-6xl mb-4 group-hover:scale-110 transition-transform">üéõÔ∏è</div>
                <div class="text-2xl font-bold text-slate-700">‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏Å‡∏£‡∏£‡∏°‡∏Å‡∏≤‡∏£</div>
            </button>
        </div>
    </div>

    <div id="display-view" class="hidden w-full h-full flex-row bg-slate-50 relative">
        <div class="absolute top-0 left-0 w-[600px] h-[600px] bg-purple-200/20 rounded-full blur-3xl -translate-y-1/2 -translate-x-1/2"></div>
        <div class="absolute bottom-0 right-0 w-[600px] h-[600px] bg-blue-200/20 rounded-full blur-3xl translate-y-1/2 translate-x-1/2"></div>

        <main class="flex-1 p-6 flex flex-col z-10 h-full relative overflow-hidden gap-4">
            <header class="text-left relative pl-4 flex-shrink-0">
                <h1 id="display-title" class="text-5xl font-extrabold text-slate-800 tracking-tight">Townhall 2026</h1>
                <div class="h-2 w-32 bg-gradient-to-r from-blue-500 to-purple-500 mt-2 rounded-full"></div>
                <div class="absolute top-0 right-0 pr-8">
                     <span class="text-xl font-bold text-slate-400">TARGET: <span class="text-slate-700">1,500</span></span>
                </div>
            </header>

            <div id="ranking-list" class="flex-1 flex flex-col gap-3 overflow-y-auto pr-2 custom-scrollbar">
            </div>

            <div id="mascot-race-area" class="flex-shrink-0 pt-2 border-t border-slate-200/50">
                <div class="flex justify-between items-center mb-2 px-2">
                    <h3 class="text-lg font-bold text-slate-700 flex items-center gap-2">üèÅ Race to Victory! <span class="text-sm text-slate-400 font-normal">(‡πÉ‡∏Ñ‡∏£‡∏ñ‡∏∂‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏ä‡∏ô‡∏∞)</span></h3>
                </div>
                
                <div id="racetrack-wrapper" class="flex flex-col gap-4 bg-slate-100/80 p-4 rounded-2xl relative overflow-hidden border border-slate-200 shadow-inner">
                    <div class="finish-line-tape absolute right-4 top-0 bottom-0 w-6 h-full z-10 shadow-sm"></div>
                    <div id="finish-line-confetti-container" class="absolute right-6 top-0 bottom-0 w-2 pointer-events-none z-30"></div>
                </div>
            </div>
        </main>

        <aside class="w-[380px] bg-white/70 backdrop-blur-xl border-l border-slate-200 p-5 flex flex-col shadow-2xl z-20 relative h-full overflow-y-auto custom-scrollbar">
            <div class="mb-4 text-center sticky top-0 bg-white/0 backdrop-blur-md py-2 z-10">
                <h2 class="text-xl font-bold text-slate-700 uppercase tracking-widest flex justify-center items-center gap-2">
                    ‚ö° Live Updates
                </h2>
            </div>
            
            <div id="team-grid-container" class="flex flex-col gap-4 pb-4">
            </div>
        </aside>
    </div>

    <div id="admin-view" class="hidden h-full overflow-y-auto bg-slate-100">
        <div class="max-w-5xl mx-auto p-8">
            <div class="bg-white rounded-3xl shadow-sm border border-slate-200 p-6 mb-8 flex justify-between items-center sticky top-4 z-30">
                <div><h1 class="text-2xl font-bold text-slate-800">‚öôÔ∏è ‡πÅ‡∏ú‡∏á‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°</h1></div>
                <div class="flex gap-4">
                     <input type="text" id="main-title-input" class="bg-slate-50 border border-slate-200 rounded-xl px-4 py-2 text-slate-700 text-center focus:ring-2 focus:ring-blue-500 outline-none w-64 font-medium transition-all" placeholder="Townhall 2026">
                    <button onclick="resetAll()" class="bg-red-50 text-red-600 border border-red-100 hover:bg-red-600 hover:text-white px-6 py-2 rounded-xl font-bold transition-all">üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</button>
                </div>
            </div>
            <div id="admin-container" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
        </div>
    </div>

    <script>
        const TARGET_SCORE = 1500;
        const EXCITED_THRESHOLD = 700; // ‡πÄ‡∏Å‡∏ì‡∏ë‡πå‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏û‡∏•‡∏á
        
        const defaultData = [
            { id: 0, name: '‡∏™‡∏µ‡πÅ‡∏î‡∏á', score: 0, count: 0, hasFinished: false, color: 'text-red-500', bg: 'bg-red-500', icon: 'üî¥', border: 'border-red-500', snailGlow: 'drop-shadow(0 0 10px rgba(239, 68, 68, 1))' },
            { id: 1, name: '‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô', score: 0, count: 0, hasFinished: false, color: 'text-blue-500', bg: 'bg-blue-500', icon: 'üîµ', border: 'border-blue-500', snailGlow: 'drop-shadow(0 0 10px rgba(59, 130, 246, 1))' },
            { id: 2, name: '‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß', score: 0, count: 0, hasFinished: false, color: 'text-green-600', bg: 'bg-green-500', icon: 'üü¢', border: 'border-green-500', snailGlow: 'drop-shadow(0 0 10px rgba(34, 197, 94, 1))' },
            { id: 3, name: '‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á', score: 0, count: 0, hasFinished: false, color: 'text-yellow-500', bg: 'bg-yellow-400', icon: 'üü°', border: 'border-yellow-400', snailGlow: 'drop-shadow(0 0 10px rgba(234, 179, 8, 1))' }
        ];

        let teams = JSON.parse(localStorage.getItem('sb_teams_v5')) || defaultData; 
        let mainTitle = localStorage.getItem('sb_title_v5') || "Townhall 2026";
        let currentMode = '';
        let currentMusicState = 'none'; // none, normal, excited

        // Audio Elements
        const sfxScore = document.getElementById('sfx-score');
        const sfxWin = document.getElementById('sfx-win');
        const sfxClick = document.getElementById('sfx-click');
        const bgmNormal = document.getElementById('bgm-normal');
        const bgmExcited = document.getElementById('bgm-excited');

        // Set volumes
        sfxScore.volume = 0.4;
        sfxWin.volume = 0.5;
        sfxClick.volume = 0.3;
        bgmNormal.volume = 0.2;
        bgmExcited.volume = 0.3;

        function playSound(type) {
            const audioMap = {
                'score': sfxScore,
                'win': sfxWin,
                'click': sfxClick
            };
            const audio = audioMap[type];
            if(audio) {
                audio.currentTime = 0;
                audio.play().catch(() => {});
            }
        }

        function checkAndUpdateMusic() {
            if(currentMode !== 'display') return;
            
            const maxScore = Math.max(...teams.map(t => t.score));
            const targetState = maxScore >= EXCITED_THRESHOLD ? 'excited' : 'normal';

            if(currentMusicState !== targetState) {
                if(targetState === 'excited') {
                    bgmNormal.pause();
                    bgmExcited.currentTime = 0;
                    bgmExcited.play().catch(() => {});
                } else {
                    bgmExcited.pause();
                    bgmNormal.currentTime = 0;
                    bgmNormal.play().catch(() => {});
                }
                currentMusicState = targetState;
            }
        }

        function enterMode(mode) {
            currentMode = mode;
            document.getElementById('mode-selector').classList.add('hidden');
            
            if(mode === 'display') {
                document.getElementById('display-view').classList.remove('hidden');
                document.getElementById('display-view').classList.add('flex');
                playSound('click');
                checkAndUpdateMusic();
                renderDisplay();
            } else {
                document.getElementById('admin-view').classList.remove('hidden');
                playSound('click');
                renderAdmin();
            }
        }

        function save() {
            localStorage.setItem('sb_teams_v5', JSON.stringify(teams));
            localStorage.setItem('sb_title_v5', mainTitle);
        }

        // --- DISPLAY RENDERER ---
        function renderDisplay() {
            if(document.getElementById('display-view').classList.contains('hidden')) return;

            document.getElementById('display-title').innerText = mainTitle;
            
            renderSidebarCards(); 
            renderRankingMain();  
            renderMascotRace();
            checkAndUpdateMusic();
        }

        function renderSidebarCards() {
            const gridContainer = document.getElementById('team-grid-container');

            if(gridContainer.children.length === 0) {
                gridContainer.innerHTML = teams.map((t, i) => `
                    <div id="card-${i}" class="display-card flex-1 rounded-2xl p-4 flex items-center justify-between relative overflow-hidden border-l-8 ${t.border.replace('text','border')}">
                        
                        <div class="flex items-center gap-4 z-10 pl-2">
                             <div class="text-4xl filter drop-shadow-sm">${t.icon}</div>
                             <div>
                                <h2 class="text-2xl font-bold text-slate-700 leading-tight">${t.name}</h2>
                                <div class="text-sm text-slate-400 mt-1 font-medium">Updates: ${t.count}</div>
                             </div>
                        </div>
                        
                        <div class="z-10 text-right pr-2">
                            <div id="score-${i}" class="text-6xl font-black leading-none ${t.color} score-anim drop-shadow-sm">${t.score}</div>
                        </div>

                        <div class="absolute bottom-0 left-0 w-full h-1.5 bg-slate-100">
                             <div id="mini-progress-${i}" class="h-full ${t.bg} opacity-60" style="width: 0%"></div>
                        </div>
                    </div>
                `).join('');
                
                setTimeout(() => {
                    teams.forEach((t, i) => {
                        const percent = Math.min(100, (t.score / TARGET_SCORE) * 100);
                        document.getElementById(`mini-progress-${i}`).style.width = `${percent}%`;
                    });
                }, 100);

            } else {
                teams.forEach((t, i) => {
                    const scoreEl = document.getElementById(`score-${i}`);
                    const oldScore = parseInt(scoreEl.innerText);
                    
                    if(oldScore !== t.score) {
                        scoreEl.innerText = t.score;
                        
                        scoreEl.classList.remove('pop');
                        void scoreEl.offsetWidth;
                        scoreEl.classList.add('pop');
                        
                        const diff = t.score - oldScore;
                        if(diff > 0) {
                            showFloatingText(i, diff);
                            playSound('score');
                        }

                        const percent = Math.min(100, (t.score / TARGET_SCORE) * 100);
                        document.getElementById(`mini-progress-${i}`).style.width = `${percent}%`;
                    }
                });
            }
        }

        function renderMascotRace() {
            const wrapper = document.getElementById('racetrack-wrapper');
            
            if(wrapper.getElementsByClassName('racetrack').length === 0) {
                 const tracksHTML = teams.map((t, i) => `
                    <div class="racetrack relative h-16 bg-white rounded-full border-2 border-slate-200 overflow-hidden z-0 shadow-sm flex items-center">
                        <div class="absolute inset-0 opacity-20 ${t.bg}"></div>
                        
                        <div class="absolute inset-0 flex items-center justify-center">
                            <div class="w-full border-b-2 border-dashed border-slate-300/50"></div>
                        </div>

                        <div id="snail-${i}" class="snail-racer" style="filter: ${t.snailGlow}">
                            <span class="relative z-10 block">üêå</span>
                        </div>
                    </div>
                `).join('');
                wrapper.insertAdjacentHTML('afterbegin', tracksHTML);
            }

            setTimeout(() => {
                teams.forEach((t, i) => {
                    const snailEl = document.getElementById(`snail-${i}`);
                    const rawPercent = (t.score / TARGET_SCORE) * 100;
                    const percent = Math.min(100, rawPercent);
                    
                    snailEl.style.left = `calc(${percent}% - 4rem)`;

                    if (percent >= 100) {
                        if (!snailEl.classList.contains('winner-snail')) {
                             snailEl.classList.add('winner-snail');
                             snailEl.innerHTML = `
                                <div class="winner-badge-container">
                                    <span class="winner-crown">üëë</span>
                                    <span class="finished-text">FINISHED!</span>
                                </div>
                                <span class="relative z-10 block">üêå</span>
                             `;
                        }

                        if (!t.hasFinished) {
                            t.hasFinished = true;
                            save();
                            playSound('win');
                            triggerFinishLineCelebration(t.bg.replace('bg-', ''));
                        }

                    } else {
                        snailEl.classList.remove('winner-snail');
                        snailEl.innerHTML = '<span class="relative z-10 block">üêå</span>';
                        if(t.hasFinished) { t.hasFinished = false; save(); }
                    }
                });
            }, 50);
        }

        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡πà‡∏ô‡∏à‡∏∏‡∏î‡∏û‡∏•‡∏∏‡∏ó‡∏µ‡πà‡πÄ‡∏™‡πâ‡∏ô‡∏ä‡∏±‡∏¢
        function triggerFinishLineCelebration(colorName) {
            const container = document.getElementById('finish-line-confetti-container');
            const colorsMap = {
                'red-500': '#ef4444',
                'blue-500': '#3b82f6',
                'green-500': '#22c55e',
                'yellow-400': '#eab308'
            };
            const colorHex = colorsMap[colorName] || '#ffd700';

            for(let i=0; i<30; i++) {
                const el = document.createElement('div');
                el.className = 'confetti-finish';
                el.style.backgroundColor = colorHex;
                el.style.top = Math.random() * 100 + '%';
                
                // ‡∏™‡∏∏‡πà‡∏°‡∏ó‡∏¥‡∏®‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡πÄ‡∏ö‡∏¥‡∏î
                const angle = Math.random() * Math.PI * 2;
                const distance = 50 + Math.random() * 100;
                el.style.setProperty('--tx', Math.cos(angle) * distance + 'px');
                el.style.setProperty('--ty', Math.sin(angle) * distance + 'px');
                
                container.appendChild(el);
                setTimeout(() => el.remove(), 1500);
            }
            // ‡πÅ‡∏ñ‡∏°‡∏û‡∏•‡∏∏‡πÉ‡∏´‡∏ç‡πà‡∏Å‡∏•‡∏≤‡∏á‡∏à‡∏≠‡∏î‡πâ‡∏ß‡∏¢
            createGlobalConfetti();
        }


        // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡πà‡∏ô‡πÅ‡∏™‡∏î‡∏á Ranking ‡∏≠‡∏±‡∏ô‡πÉ‡∏´‡∏ç‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏ã‡πâ‡∏≤‡∏¢
        function renderRankingMain() {
            const container = document.getElementById('ranking-list');
            const sortedTeams = [...teams].sort((a, b) => b.score - a.score);

            container.innerHTML = sortedTeams.map((t, index) => {
                const percent = Math.min(100, (t.score / TARGET_SCORE) * 100);
                const rank = index + 1;
                
                let rankDisplay = '';
                let containerClass = 'bg-white/90 border-slate-200';
                let heightClass = 'h-28'; 
                let scoreSize = 'text-6xl';
                let iconSize = 'text-5xl';
                let nameSize = 'text-3xl';

                if(rank === 1) {
                    rankDisplay = `<div class="text-7xl mr-5 medal-icon drop-shadow-md">ü•á</div>`;
                    containerClass = 'bg-gradient-to-r from-yellow-50 to-white border-yellow-300';
                    heightClass = 'h-44'; 
                    scoreSize = 'text-8xl';
                    iconSize = 'text-7xl';
                    nameSize = 'text-5xl';
                } else if(rank === 2) {
                    rankDisplay = `<div class="text-6xl mr-5 medal-icon drop-shadow-md" style="animation-delay: 0.5s">ü•à</div>`;
                    containerClass = 'bg-gradient-to-r from-slate-50 to-white border-slate-300';
                    heightClass = 'h-36';
                    scoreSize = 'text-7xl';
                    iconSize = 'text-6xl';
                    nameSize = 'text-4xl';
                } else if(rank === 3) {
                    rankDisplay = `<div class="text-6xl mr-5 medal-icon drop-shadow-md" style="animation-delay: 1s">ü•â</div>`;
                    containerClass = 'bg-gradient-to-r from-orange-50 to-white border-orange-300';
                    heightClass = 'h-36';
                    scoreSize = 'text-7xl';
                    iconSize = 'text-6xl';
                    nameSize = 'text-4xl';
                } else {
                    rankDisplay = `<div class="text-4xl font-black text-slate-300 mr-6 w-14 text-center">#${rank}</div>`;
                }

                return `
                <div class="w-full ${containerClass} backdrop-blur-md rounded-[2rem] border-2 shadow-sm px-8 py-4 flex items-center justify-between transition-all duration-500 relative overflow-hidden ${heightClass}">
                    
                    <div class="flex items-center z-10">
                        ${rankDisplay}
                        <div>
                            <div class="flex items-center gap-4">
                                <span class="${iconSize} filter drop-shadow-sm">${t.icon}</span>
                                <span class="font-extrabold text-slate-700 ${nameSize} tracking-tight">${t.name}</span>
                            </div>
                        </div>
                    </div>

                    <div class="flex flex-col items-end justify-center z-10 w-1/2 h-full">
                        <span class="font-black ${t.color} ${scoreSize} mb-2 leading-none filter drop-shadow-sm">${t.score}</span>
                        <div class="progress-track h-5 w-full bg-slate-200/50 rounded-full overflow-hidden border border-slate-300/50">
                             <div class="progress-bar ${t.bg} h-full rounded-full shadow-sm" style="width: ${percent}%"></div>
                        </div>
                    </div>
                </div>
                `;
            }).join('');
        }

        function showFloatingText(index, diff) {
            const card = document.getElementById(`card-${index}`);
            const el = document.createElement('div');
            el.className = 'floating-score';
            
            const colorClass = teams[index].color; 
            el.classList.add(colorClass); 

            el.innerText = (diff > 0 ? '+' : '') + diff;
            
            el.style.right = '20px';
            el.style.top = '50%';
            el.style.transform = 'translate(0, -50%)';
            
            card.appendChild(el);
            setTimeout(() => el.remove(), 1000);

            // ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ö‡∏ß‡∏Å‡πÄ‡∏¢‡∏≠‡∏∞‡πÜ ‡πÉ‡∏´‡πâ‡∏à‡∏∏‡∏î‡∏û‡∏•‡∏∏‡πÉ‡∏´‡∏ç‡πà‡∏î‡πâ‡∏ß‡∏¢
            if(diff >= 300) createGlobalConfetti();
        }

        // --- ADMIN RENDERER (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°) ---
        function renderAdmin() {
            if(document.getElementById('admin-view').classList.contains('hidden')) return;
            document.getElementById('main-title-input').value = mainTitle;
            const container = document.getElementById('admin-container');
            
            container.innerHTML = teams.map((t, i) => `
                <div class="bg-white rounded-3xl p-6 shadow-sm border border-slate-200 border-l-8 ${t.border.replace('text','border')}">
                    <div class="flex items-center gap-4 mb-6">
                        <div class="text-4xl bg-slate-50 p-3 rounded-2xl">${t.icon}</div>
                        <input type="text" value="${t.name}" onchange="updateName(${i}, this.value)"
                            class="text-2xl font-bold text-slate-800 bg-transparent border-b-2 border-transparent focus:border-blue-500 outline-none flex-1">
                    </div>
                    
                    <div class="flex justify-between items-end mb-6">
                        <div>
                            <div class="text-xs text-slate-400 uppercase font-bold tracking-wider">Score</div>
                            <div class="text-5xl font-extrabold ${t.color}">${t.score}</div>
                        </div>
                         <div class="text-right">
                             <div class="text-xs text-slate-400 uppercase font-bold tracking-wider">Status</div>
                             <div class="text-lg font-bold ${t.hasFinished ? 'text-green-500' : 'text-slate-400'}">
                                ${t.hasFinished ? 'FINISHED üèÅ' : 'Racing...'}
                             </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-3 gap-3 mb-4">
                        <button onclick="addScore(${i}, 100)" class="py-3 rounded-xl bg-slate-50 hover:bg-green-50 text-slate-600 hover:text-green-600 font-bold border border-slate-200 transition-all">+100</button>
                        <button onclick="addScore(${i}, 200)" class="py-3 rounded-xl bg-slate-50 hover:bg-green-50 text-slate-600 hover:text-green-600 font-bold border border-slate-200 transition-all">+200</button>
                        <button onclick="addScore(${i}, 300)" class="py-3 rounded-xl bg-green-500 hover:bg-green-600 text-white font-bold shadow-lg shadow-green-200 transition-all">+300</button>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-3 mb-4">
                        <button onclick="addScore(${i}, -100)" class="py-2 rounded-xl bg-slate-50 hover:bg-red-50 text-slate-400 hover:text-red-500 font-medium text-sm border border-slate-200">-100</button>
                        <button onclick="addScore(${i}, -200)" class="py-2 rounded-xl bg-slate-50 hover:bg-red-50 text-slate-400 hover:text-red-500 font-medium text-sm border border-slate-200">-200</button>
                        <button onclick="addScore(${i}, -300)" class="py-2 rounded-xl bg-slate-50 hover:bg-red-50 text-slate-400 hover:text-red-500 font-medium text-sm border border-slate-200">-300</button>
                    </div>
                    <div class="pt-4 border-t border-slate-100">
                        <button onclick="resetTeam(${i})" class="w-full py-2 text-slate-400 hover:text-red-500 text-sm font-medium transition-colors">üîÑ ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ó‡∏µ‡∏°‡∏ô‡∏µ‡πâ</button>
                    </div>
                </div>
            `).join('');
        }

        // --- ACTIONS ---
        function addScore(index, val) {
            teams[index].score += val;
            if(teams[index].score < 0) teams[index].score = 0;
            if(teams[index].score > TARGET_SCORE) teams[index].score = TARGET_SCORE; 
            teams[index].count++;
            save();
            renderAdmin(); 
            renderDisplay();
        }

        function updateName(index, val) {
            teams[index].name = val;
            save();
        }

        function resetTeam(index) {
            if(confirm('‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏µ‡∏°‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô 0?')) {
                teams[index].score = 0;
                teams[index].count = 0;
                teams[index].hasFinished = false;
                save();
                renderAdmin();
                renderDisplay();
            }
        }

        function resetAll() {
            if(confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?')) {
                teams.forEach(t => { t.score = 0; t.count = 0; t.hasFinished = false; });
                save();
                renderAdmin();
                renderDisplay();
            }
        }

        // Confetti ‡πÅ‡∏ö‡∏ö‡∏ó‡∏±‡πà‡∏ß‡∏à‡∏≠ (‡πÉ‡∏ä‡πâ‡∏ï‡∏≠‡∏ô‡∏ö‡∏ß‡∏Å‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏¢‡∏≠‡∏∞‡πÜ ‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏≠‡∏ô‡∏à‡∏ö)
        function createGlobalConfetti() {
            const colors = ['#ef4444', '#3b82f6', '#22c55e', '#eab308'];
            for(let i=0; i<50; i++) {
                const el = document.createElement('div');
                el.className = 'confetti-general';
                el.style.left = Math.random()*100 + 'vw';
                el.style.backgroundColor = colors[Math.floor(Math.random()*colors.length)];
                el.style.animationDelay = Math.random() + 's';
                document.body.appendChild(el);
                setTimeout(() => el.remove(), 2500);
            }
        }

        window.addEventListener('storage', (e) => {
            if(e.key === 'sb_teams_v5') {
                teams = JSON.parse(e.newValue);
                renderDisplay();
                renderAdmin();
            }
            if(e.key === 'sb_title_v5') {
                mainTitle = e.newValue;
                document.getElementById('display-title').innerText = mainTitle;
                document.getElementById('main-title-input').value = mainTitle;
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
             document.getElementById('main-title-input').addEventListener('input', (e) => {
                mainTitle = e.target.value;
                save();
            });
        });
    </script>
</body>
</html>
